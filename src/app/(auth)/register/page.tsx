"use client";
//Generated by GeneratePageFile
import Link from "next/link";
import React from "react";
import {
  Formik,
  Field,
  ErrorMessage,
  FormikProps,
  FormikHelpers,
} from "formik";
import registrationSchema from "@/schema/registration";
import axiosClient from "@/utils/api";
import {
  QueryClient,
  QueryClientProvider,
  useMutation,
} from "@tanstack/react-query";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";
import { Alert, AlertDescription } from "@/components/ui/Alert";
import { AlertCircle } from "lucide-react";
import { toast } from "@/hooks/use-toast";

interface FormValues {
  username: string;
  email: string;
  password: string;
  passwordConfirmation: string;
}

// Create a QueryClient instance
const queryClient = new QueryClient();

//@ts-ignore
const Register: React.FC = () => {
  return (
    <QueryClientProvider client={queryClient}>
      <RegisterForm />
    </QueryClientProvider>
  );
};

const RegisterForm: React.FC = () => {
  const initialValues = {
    username: "jet_pradas",
    email: "jet_pradas@yahoo.com",
    password: "Jetpogi_21",
    passwordConfirmation: "Jetpogi_21",
  };

  const intialErrors = { email: "Email not available" };

  const registerUser = async (values: FormValues) => {
    const { data } = await axiosClient.post("/auth/signup", values);
    return data;
  };

  const { isLoading, mutateAsync } = useMutation(registerUser);

  const handleSubmit = async (
    values: FormValues,
    { setSubmitting, setFieldError, setStatus }: FormikHelpers<FormValues>
  ) => {
    //Use useMutation here from tanstack-query
    try {
      const data = await mutateAsync(values);

      if (data.status === "success") {
        toast({
          description: data.data.message,
          variant: "success",
        });
      }
      console.log(data);
    } catch (e: any) {
      const targetField = e.response.data.targetField;
      const errorMsg = e.response.data.error;

      if (targetField) {
        setFieldError(targetField, errorMsg);
      } else {
        setStatus({ status: "error", msg: errorMsg });
      }
    }

    setSubmitting(false);
  };

  return (
    <div className="flex flex-col items-center flex-1 w-full max-w-[500px] mx-auto">
      <h1 className="my-5 text-5xl ">Sign Up</h1>
      <Formik
        initialValues={initialValues}
        validationSchema={registrationSchema}
        onSubmit={handleSubmit}
        validateOnChange={false}
        initialErrors={intialErrors}
        enableReinitialize={true}
      >
        {({
          isSubmitting,
          submitForm,
          errors,
          status,
        }: FormikProps<FormValues>) => {
          return (
            <form
              className="flex flex-col gap-4 w-full px-4 md:w-[400px]"
              onSubmit={(e) => {
                e.preventDefault();
                submitForm();
              }}
            >
              {status && (
                <Alert variant="destructive">
                  <AlertCircle className="w-4 h-4" />
                  <AlertDescription>{status}</AlertDescription>
                </Alert>
              )}
              <div></div>
              <div className="flex flex-col gap-2">
                <Label
                  htmlFor="username"
                  className="pl-2 text-base"
                >
                  Username
                </Label>
                <Field
                  id="username"
                  type="text"
                  name="username"
                  placeholder="username"
                  as={Input}
                  required
                />
                <ErrorMessage
                  name="username"
                  component={Label}
                  className="pl-2 text-xs text-red-500"
                />
              </div>
              <div className="flex flex-col gap-2">
                <Label
                  htmlFor="email"
                  className="pl-2 text-base"
                >
                  Email address
                </Label>
                <Field
                  type="email"
                  name="email"
                  placeholder="email address"
                  as={Input}
                  required
                />
                <ErrorMessage
                  name="email"
                  component="div"
                  className="pl-2 text-xs text-red-500"
                />
              </div>
              <div className="flex flex-col gap-2">
                <Label
                  htmlFor="password"
                  className="pl-2 text-base"
                >
                  Password
                </Label>
                <Field
                  type="password"
                  name="password"
                  placeholder="password"
                  as={Input}
                  required
                />
                <ErrorMessage
                  name="password"
                  component="div"
                  className="pl-2 text-xs text-red-500"
                />
              </div>
              <div className="flex flex-col gap-2">
                <Label
                  htmlFor="passwordConfirmation"
                  className="pl-2 text-base"
                >
                  Confirm Password
                </Label>
                <Field
                  type="password"
                  name="passwordConfirmation"
                  placeholder="Confirm Password"
                  as={Input}
                  required
                />
                <ErrorMessage
                  name="passwordConfirmation"
                  component="div"
                  className="pl-2 text-xs text-red-500"
                />
              </div>
              <Button
                type="submit"
                variant="secondary"
                disabled={isSubmitting || isLoading}
              >
                Register
              </Button>
              <span className="text-sm text-center">
                Already have an account?{" "}
                <Link
                  href="/login"
                  className="underline underline-offset-4"
                >
                  Login here
                </Link>
              </span>
            </form>
          );
        }}
      </Formik>
    </div>
  );
};

export default Register;
